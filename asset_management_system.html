<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ë¸Œë¼ë³´ë¹„ë²„íŒŒì£¼ ìì‚°ê´€ë¦¬ ì‹œìŠ¤í…œ with Firebase</title>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
    <style>
        /* ìŠ¤íƒ€ì¼ ìƒëµ - ì´ì „ì— ì œê³µí•œ CSS ì „ì²´ ë³µì‚¬ ì‚¬ìš© ê°€ëŠ¥ */
        /* ... */
        * { margin: 0; padding: 0; box-sizing: border-box;}
        body { font-family: 'Arial', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px;}
        .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 15px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); padding: 30px;}
        .header { text-align: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 3px solid #667eea;}
        .header h1 { color: #333; font-size: 2.5em; margin-bottom: 10px;}
        .header p { color: #666; font-size: 1.1em;}
        .tabs { display: flex; margin-bottom: 30px; background: #f8f9fa; border-radius: 10px; padding: 5px;}
        .tab-button { flex: 1; padding: 15px 20px; border: none; background: transparent; cursor: pointer; border-radius: 8px; font-weight: bold; transition: all 0.3s ease; color: #666;}
        .tab-button.active { background: #667eea; color: white; box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);}
        .tab-content { display: none;}
        .tab-content.active { display: block;}
        .form-group { margin-bottom: 20px;}
        .form-group label { display: block; margin-bottom: 8px; font-weight: bold; color: #333;}
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px; border: 2px solid #e1e5e9; border-radius: 8px; font-size: 16px; transition: border-color 0.3s ease;}
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);}
        .btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 12px 25px; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; transition: transform 0.2s ease; margin-right: 10px; margin-bottom: 10px;}
        .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);}
        .btn-secondary { background: #6c757d;}
        .btn-danger { background: #dc3545;}
        .btn-success { background: #28a745;}
        .asset-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; margin-top: 20px;}
        .asset-card { background: white; border: 2px solid #e1e5e9; border-radius: 10px; padding: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.08); transition: transform 0.2s ease;}
        .asset-card:hover {transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0,0,0,0.15);}
        .asset-card h3 { color: #333; margin-bottom: 10px; font-size: 1.3em;}
        .asset-info { margin-bottom: 15px;}
        .asset-info span { display: block; margin-bottom: 5px; color: #666;}
        .qr-code { text-align: center; margin: 15px 0;}
        .qr-code canvas { border: 1px solid #ddd; border-radius: 8px;}
        .search-box { width: 100%; padding: 15px; font-size: 18px; border: 2px solid #667eea; border-radius: 10px; margin-bottom: 20px;}
        .search-box:focus { outline: none; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);}
        .stats {display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;}
        .stat-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 10px; text-align: center;}
        .stat-card h3 { font-size: 2em; margin-bottom: 5px;}
        .stat-card p { font-size: 1.1em; opacity: 0.9;}
        .camera-container { text-align: center; margin: 20px 0;}
        #video { width: 100%; max-width: 500px; border: 2px solid #667eea; border-radius: 10px;}
        .export-section { margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 10px;}
        @media (max-width: 768px) {
            .container { padding: 20px;}
            .tabs { flex-direction: column;}
            .tab-button { margin-bottom: 5px;}
            .asset-grid { grid-template-columns: 1fr;}
        }
        /* ìˆ˜ì • ëª¨ë‹¬ */
        #edit-modal {
            display: none;
            position: fixed;
            z-index: 9999;
            left: 0; top: 0;
            width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.3);
            justify-content: center;
            align-items: center;
        }
        #edit-modal > div {
            background: white;
            padding: 30px;
            border-radius: 14px;
            min-width: 350px;
            max-width: 95vw;
            position: relative;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¢ ë¸Œë¼ë³´ë¹„ë²„íŒŒì£¼ ìì‚°ê´€ë¦¬ì‹œìŠ¤í…œ</h1>
            <p>QR ì½”ë“œ ê¸°ë°˜ ìì‚° ê´€ë¦¬ ì†”ë£¨ì…˜</p>
        </div>

        <div class="tabs">
            <button class="tab-button active" onclick="showTab('add', this)">ìì‚° ë“±ë¡</button>
            <button class="tab-button" onclick="showTab('list', this)">ìì‚° ëª©ë¡</button>
            <button class="tab-button" onclick="showTab('scan', this)">QR ìŠ¤ìº”</button>
            <button class="tab-button" onclick="showTab('stats', this)">í†µê³„</button>
        </div>

        <!-- ìì‚° ë“±ë¡ íƒ­ -->
        <div id="add-tab" class="tab-content active">
            <h2>ğŸ”¥ ìƒˆ ìì‚° ë“±ë¡</h2>
            <form id="asset-form">
                <div class="form-group">
                    <label for="assetName">ìì‚°ëª… *</label>
                    <input type="text" id="assetName" name="assetName" required placeholder="ì˜ˆ: ë…¸íŠ¸ë¶, ì±…ìƒ, ì˜ì ë“±">
                </div>
                <div class="form-group">
                    <label for="modelName">ëª¨ë¸ëª…</label>
                    <input type="text" id="modelName" name="modelName" placeholder="ì˜ˆ: ThinkPad X1 Carbon">
                </div>
                <div class="form-group">
                    <label for="serialNumber">ì‹œë¦¬ì–¼ë„˜ë²„</label>
                    <input type="text" id="serialNumber" name="serialNumber" placeholder="ì˜ˆ: SN1234567890">
                </div>
                <div class="form-group">
                    <label for="assetCategory">ì¹´í…Œê³ ë¦¬ *</label>
                    <select id="assetCategory" name="assetCategory" required>
                        <option value="">ì¹´í…Œê³ ë¦¬ ì„ íƒ</option>
                        <option value="ì‚¬ë¬´ê¸°ê¸°">ì‚¬ë¬´ê¸°ê¸°</option>
                        <option value="ê°€ì „ì œí’ˆ">ê°€ì „ì œí’ˆ</option>
                        <option value="ê°€êµ¬">ê°€êµ¬</option>
                        <option value="ê¸°ê³„ì¥ë¹„">ê¸°ê³„ì¥ë¹„</option>
                        <option value="ì°¨ëŸ‰">ì°¨ëŸ‰</option>
                        <option value="ê¸°íƒ€">ê¸°íƒ€</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="assetLocation">ìœ„ì¹˜ *</label>
                    <select id="assetLocation" name="assetLocation" required>
                        <option value="">ìœ„ì¹˜ ì„ íƒ</option>
                        <option value="ì‚¬ë¬´ì‹¤">ì‚¬ë¬´ì‹¤</option>
                        <option value="ì‘ì—…ì¥">ì‘ì—…ì¥</option>
                        <option value="ê·¸ë¼ìš´ë“œ">ê·¸ë¼ìš´ë“œ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="assetValue">ìì‚°ê°€ì¹˜ (ì›)</label>
                    <input type="number" id="assetValue" name="assetValue" placeholder="ì˜ˆ: 500000">
                </div>
                <div class="form-group">
                    <label for="purchaseDate">êµ¬ì…ì¼ì</label>
                    <input type="date" id="purchaseDate" name="purchaseDate">
                </div>
                <div class="form-group">
                    <label for="assetDescription">ì„¤ëª…</label>
                    <textarea id="assetDescription" name="assetDescription" rows="3" placeholder="ìì‚°ì— ëŒ€í•œ ì¶”ê°€ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
                </div>
                <button type="submit" class="btn">ìì‚° ë“±ë¡ ë° QRì½”ë“œ ìƒì„±</button>
            </form>
        </div>

        <!-- ìì‚° ëª©ë¡ íƒ­ -->
        <div id="list-tab" class="tab-content">
            <h2>ğŸ“‹ ìì‚° ëª©ë¡</h2>
            <input type="text" id="searchInput" class="search-box" placeholder="ğŸ” ìì‚°ëª…, ì¹´í…Œê³ ë¦¬, ìœ„ì¹˜ë¡œ ê²€ìƒ‰í•˜ì„¸ìš”...">

            <div class="export-section">
                <h3>ğŸ“Š ë°ì´í„° ë‚´ë³´ë‚´ê¸°</h3>
                <button class="btn btn-success" onclick="exportToCSV()">CSV íŒŒì¼ ë‹¤ìš´ë¡œë“œ</button>
                <button class="btn btn-secondary" onclick="printAssets()">ëª©ë¡ ì¸ì‡„</button>
            </div>

            <div id="asset-list" class="asset-grid"></div>
        </div>

        <!-- QR ìŠ¤ìº” íƒ­ -->
        <div id="scan-tab" class="tab-content">
            <h2>ğŸ“± QR ì½”ë“œ ìŠ¤ìº”</h2>
            <div class="camera-container">
                <video id="video" autoplay></video>
                <canvas id="canvas" style="display:none;"></canvas>
            </div>
            <button class="btn" onclick="startCamera()">ì¹´ë©”ë¼ ì‹œì‘</button>
            <button class="btn btn-secondary" onclick="stopCamera()">ì¹´ë©”ë¼ ì¤‘ì§€</button>
            <div id="scan-result"></div>
        </div>

        <!-- í†µê³„ íƒ­ -->
        <div id="stats-tab" class="tab-content">
            <h2>ğŸ“Š ìì‚° í†µê³„</h2>
            <div class="stats">
                <div class="stat-card">
                    <h3 id="total-assets">0</h3>
                    <p>ì´ ìì‚° ìˆ˜</p>
                </div>
                <div class="stat-card">
                    <h3 id="total-value">0ì›</h3>
                    <p>ì´ ìì‚° ê°€ì¹˜</p>
                </div>
                <div class="stat-card">
                    <h3 id="categories-count">0</h3>
                    <p>ì¹´í…Œê³ ë¦¬ ìˆ˜</p>
                </div>
                <div class="stat-card">
                    <h3 id="locations-count">3</h3>
                    <p>ìœ„ì¹˜ ìˆ˜</p>
                </div>
            </div>
            <div id="category-stats"></div>
            <div id="location-stats"></div>
        </div>
    </div>

    <!-- ìì‚° ì •ë³´ ìˆ˜ì • ëª¨ë‹¬ -->
    <div id="edit-modal">
        <div>
            <form id="edit-form">
                <h2>ìì‚° ì •ë³´ ìˆ˜ì •</h2>
                <input type="hidden" id="edit-id" />
                <div class="form-group">
                    <label>ê´€ë¦¬ë²ˆí˜¸</label>
                    <input type="text" id="edit-managementNumber" readonly/>
                </div>
                <div class="form-group">
                    <label>ìì‚°ëª… *</label>
                    <input type="text" id="edit-assetName" required />
                </div>
                <div class="form-group">
                    <label>ëª¨ë¸ëª…</label>
                    <input type="text" id="edit-modelName" />
                </div>
                <div class="form-group">
                    <label>ì‹œë¦¬ì–¼ë„˜ë²„</label>
                    <input type="text" id="edit-serialNumber" />
                </div>
                <div class="form-group">
                    <label>ì¹´í…Œê³ ë¦¬ *</label>
                    <select id="edit-assetCategory" required>
                        <option value="">ì¹´í…Œê³ ë¦¬ ì„ íƒ</option>
                        <option value="ì‚¬ë¬´ê¸°ê¸°">ì‚¬ë¬´ê¸°ê¸°</option>
                        <option value="ê°€ì „ì œí’ˆ">ê°€ì „ì œí’ˆ</option>
                        <option value="ê°€êµ¬">ê°€êµ¬</option>
                        <option value="ê¸°ê³„ì¥ë¹„">ê¸°ê³„ì¥ë¹„</option>
                        <option value="ì°¨ëŸ‰">ì°¨ëŸ‰</option>
                        <option value="ê¸°íƒ€">ê¸°íƒ€</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ìœ„ì¹˜ *</label>
                    <select id="edit-assetLocation" required>
                        <option value="">ìœ„ì¹˜ ì„ íƒ</option>
                        <option value="ì‚¬ë¬´ì‹¤">ì‚¬ë¬´ì‹¤</option>
                        <option value="ì‘ì—…ì¥">ì‘ì—…ì¥</option>
                        <option value="ê·¸ë¼ìš´ë“œ">ê·¸ë¼ìš´ë“œ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ê°€ì¹˜ (ì›)</label>
                    <input type="number" id="edit-assetValue" />
                </div>
                <div class="form-group">
                    <label>êµ¬ì…ì¼ì</label>
                    <input type="date" id="edit-purchaseDate" />
                </div>
                <div class="form-group">
                    <label>ì„¤ëª…</label>
                    <textarea id="edit-assetDescription" rows="3"></textarea>
                </div>
                <button type="submit" class="btn btn-success">ì €ì¥</button>
                <button type="button" class="btn btn-secondary" onclick="closeEditModal()">ì·¨ì†Œ</button>
            </form>
        </div>
    </div>

    <script>
const categoryToAlpha = {
  "ì‚¬ë¬´ê¸°ê¸°": "S",
  "ì „ìì œí’ˆ": "A",
  "ê°€êµ¬": "F",
  "ê¸°ê³„ì¥ë¹„": "M",
  "ê¸°íƒ€": "O"
};

function generateManagementNumber(purchaseDate, category) {
  if (!purchaseDate) {
    alert("êµ¬ì…ì¼ìë¥¼ ë°˜ë“œì‹œ ì…ë ¥í•´ì•¼ ê´€ë¦¬ë²ˆí˜¸ë¥¼ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
    return null;
  }
  const prefix = "íŒŒì£¼";
  const date = new Date(purchaseDate);
  const year = date.getFullYear().toString().slice(2);
  const month = (date.getMonth() + 1).toString().padStart(2, "0");
  const ym = year + month;
  const alpha = categoryToAlpha[category] || "O";

  // ê¸°ì¡´ ë°ì´í„°ì—ì„œ ê°™ì€ ì—°ì›”/ì¹´í…Œê³ ë¦¬ ìì‚° ê°œìˆ˜ ê³„ì‚°
  const count = assets.filter((a) => {
    if (!a.purchaseDate || !a.category) return false;
    const d = new Date(a.purchaseDate);
    const aYM = d.getFullYear().toString().slice(2) + (d.getMonth() + 1).toString().padStart(2, "0");
    const aAlpha = categoryToAlpha[a.category] || "O";
    return aYM === ym && aAlpha === alpha;
  }).length;

  const serialNum = (count + 1).toString().padStart(3, "0");
  return `${prefix}-${ym}-${alpha}-${serialNum}`;
}
        
<script>
  // firebase ì •ë³´
  const firebaseConfig = {
    apiKey: "AIzaSyAust7Qcf2EgA2c8vczSiASXiPT5xaRuLg",
    authDomain: "bravo-beaver-asset.firebaseapp.com",
    databaseURL: "https://bravo-beaver-asset-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "bravo-beaver-asset",
    storageBucket: "bravo-beaver-asset.firebasestorage.app",
    messagingSenderId: "698947651541",
    appId: "1:698947651541:web:876688653b0f8080425f5c"
  };

    // Firebase ì´ˆê¸°í™”
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    const assetsRef = database.ref('assets');

    // ìì‚° ë°ì´í„° ë°°ì—´
    let assets = [];

    // íƒ­ ì „í™˜ ê¸°ëŠ¥
    function showTab(tabName, btn) {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
        document.getElementById(tabName + '-tab').classList.add('active');
        btn.classList.add('active');
        if(tabName === 'list') displayAssets();
        if(tabName === 'stats') updateStats();
    }

    // ì‹ ê·œ ìì‚° ë“±ë¡ í¼ ì´ë²¤íŠ¸
    document.getElementById('asset-form').addEventListener('submit', e => {
        e.preventDefault();
        const purchaseDate = e.target.purchaseDate.value;
        const category = e.target.assetCategory.value;
        const managementNumber = generateManagementNumber(purchaseDate, category);
  if (!managementNumber) return;     
        const assetData = {
            name: e.target.assetName.value.trim(),
            modelName: e.target.modelName.value.trim(),
            serialNumber: e.target.serialNumber.value.trim(),
            category: e.target.assetCategory.value,
            location: e.target.assetLocation.value,
            value: parseInt(e.target.assetValue.value) || 0,
            purchaseDate: e.target.purchaseDate.value,
            description: e.target.assetDescription.value.trim(),
            registrationDate: new Date().toISOString()
        };
        assetsRef.push(assetData, err => {
            if(err) {
                alert('ë“±ë¡ ì‹¤íŒ¨: ' + err.message);
            } else {
                alert('ìì‚° ë“±ë¡ ì™„ë£Œ');
                e.target.reset();
                showTab('list', document.querySelector('.tab-button:nth-child(2)'));
            }
        });
    });

    // Firebase ë°ì´í„° ë³€ê²½ ì‹¤ì‹œê°„ ê°ì§€
    assetsRef.on('value', snapshot => {
        const data = snapshot.val() || {};
        assets = Object.entries(data).map(([id, value]) => ({ id, ...value }));
        if(document.querySelector('.tab-button.active').textContent === 'ìì‚° ëª©ë¡') {
            displayAssets();
        }
        updateStats();
    });

    const assetListEl = document.getElementById('asset-list');
    const searchInput = document.getElementById('searchInput');

    searchInput.addEventListener('input', () => {
        displayAssets();
    });

    // ìì‚° ëª©ë¡ ë³´ì—¬ì£¼ê¸°
    function displayAssets() {
        let filter = searchInput.value.toLowerCase();
        const filtered = assets.filter(a =>
            a.name.toLowerCase().includes(filter) ||
            a.category.toLowerCase().includes(filter) ||
            a.location.toLowerCase().includes(filter) ||
            (a.description && a.description.toLowerCase().includes(filter)) ||
            (a.modelName && a.modelName.toLowerCase().includes(filter)) ||
            (a.serialNumber && a.serialNumber.toLowerCase().includes(filter))
        );
        if(filtered.length === 0) {
            assetListEl.innerHTML = '<div style="text-align:center; color:#666; padding:50px;">ë“±ë¡ëœ ìì‚°ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
            return;
        }
        assetListEl.innerHTML = filtered.map(asset => `
            <div class="asset-card">
                <h3>${asset.name}</h3>
                <div class="asset-info">
                    <span><strong>ê´€ë¦¬ë²ˆí˜¸:</strong> ${asset.managementNumber}</span>
                    <span><strong>ëª¨ë¸ëª…:</strong> ${asset.modelName || 'ë¯¸ì…ë ¥'}</span>
                    <span><strong>ì‹œë¦¬ì–¼ë„˜ë²„:</strong> ${asset.serialNumber || 'ë¯¸ì…ë ¥'}</span>
                    <span><strong>ì¹´í…Œê³ ë¦¬:</strong> ${asset.category}</span>
                    <span><strong>ìœ„ì¹˜:</strong> ${asset.location}</span>
                    <span><strong>ê°€ì¹˜:</strong> ${asset.value ? asset.value.toLocaleString() + 'ì›' : 'ë¯¸ì…ë ¥'}</span>
                    <span><strong>êµ¬ì…ì¼:</strong> ${asset.purchaseDate || 'ë¯¸ì…ë ¥'}</span>
                    <span><strong>ë“±ë¡ì¼:</strong> ${new Date(asset.registrationDate).toLocaleString()}</span>
                    ${asset.description ? `<span><strong>ì„¤ëª…:</strong> ${asset.description}</span>` : ''}
                </div>
                <div class="qr-code" id="qr-${asset.id}"></div>
                <button class="btn btn-danger" onclick="deleteAsset('${asset.id}')">ì‚­ì œ</button>
                <button class="btn btn-secondary" onclick="downloadQR('${asset.id}')">QR ë‹¤ìš´ë¡œë“œ</button>
                <button class="btn btn-secondary" onclick="editAsset('${asset.id}')">ìˆ˜ì •</button>
            </div>
        `).join('');
        filtered.forEach(asset => {
            const qrData = JSON.stringify({
                id: asset.id,
                managementNumber: asset.managementNumber,
                name: asset.name,
                modelName: asset.modelName,
                serialNumber: asset.serialNumber,
                category: asset.category,
                location: asset.location
            });
            QRCode.toCanvas(document.getElementById(`qr-${asset.id}`), qrData, {
                width: 150,
                margin: 1,
                color: { dark: '#000000', light: '#FFFFFF' }
            }, error => {
                if(error) console.error(error);
            });
        });
    }

    // ìì‚° ì‚­ì œ
    function deleteAsset(id) {
        if(confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            assetsRef.child(id).remove().then(() => {
                alert('ì‚­ì œ ì™„ë£Œ');
            }).catch(error => alert('ì‚­ì œ ì‹¤íŒ¨: ' + error.message));
        }
    }

    // QR ë‹¤ìš´ë¡œë“œ
    function downloadQR(id) {
        const canvas = document.querySelector(`#qr-${id} canvas`);
        if(canvas) {
            const link = document.createElement('a');
            link.download = `qr-${id}.png`;
            link.href = canvas.toDataURL();
            link.click();
        }
    }

    // ìì‚° ìˆ˜ì • ëª¨ë‹¬ ì—´ê¸°
    function editAsset(id) {
        const asset = assets.find(a => a.id === id);
        if(!asset) return;
        document.getElementById('edit-id').value = asset.id;
        document.getElementById("edit-managementNumber").value = asset.managementNumber;
        document.getElementById('edit-assetName').value = asset.name;
        document.getElementById('edit-modelName').value = asset.modelName || '';
        document.getElementById('edit-serialNumber').value = asset.serialNumber || '';
        document.getElementById('edit-assetCategory').value = asset.category;
        document.getElementById('edit-assetLocation').value = asset.location;
        document.getElementById('edit-assetValue').value = asset.value || '';
        document.getElementById('edit-purchaseDate').value = asset.purchaseDate || '';
        document.getElementById('edit-assetDescription').value = asset.description || '';
        document.getElementById('edit-modal').style.display = 'flex';
    }

    // ìˆ˜ì • í¼ ì œì¶œ
    document.getElementById('edit-form').addEventListener('submit', e => {
        e.preventDefault();
        const id = document.getElementById('edit-id').value;
        // ê´€ë¦¬ë²ˆí˜¸ëŠ” ìˆ˜ì • ë¶ˆ
        const updatedData = {
            name: document.getElementById('edit-assetName').value.trim(),
            modelName: document.getElementById('edit-modelName').value.trim(),
            serialNumber: document.getElementById('edit-serialNumber').value.trim(),
            category: document.getElementById('edit-assetCategory').value,
            location: document.getElementById('edit-assetLocation').value,
            value: parseInt(document.getElementById('edit-assetValue').value) || 0,
            purchaseDate: document.getElementById('edit-purchaseDate').value,
            description: document.getElementById('edit-assetDescription').value.trim()
        };
        assetsRef.child(id).update(updatedData).then(() => {
            alert('ìˆ˜ì • ì™„ë£Œ');
            closeEditModal();
        }).catch(e => alert('ìˆ˜ì • ì‹¤íŒ¨: ' + e.message));
    });

    function closeEditModal() {
        document.getElementById('edit-modal').style.display = 'none';
    }

    // CSV ë‚´ë³´ë‚´ê¸°
    async function exportToCSV() {
        if(assets.length === 0) {
            alert('ë‚´ë³´ë‚¼ ìì‚°ì´ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }
        const headers = ['ê´€ë¦¬ë²ˆí˜¸','ìì‚°ëª…','ëª¨ë¸ëª…','ì‹œë¦¬ì–¼ë„˜ë²„','ì¹´í…Œê³ ë¦¬','ìœ„ì¹˜','ê°€ì¹˜','êµ¬ì…ì¼','ë“±ë¡ì¼','ì„¤ëª…','QRì½”ë“œ(Base64)'];
        async function getQRCodeDataURL(asset) {
            const qrData = JSON.stringify({
                id: asset.id,
                managementNumber: asset.managementNumber,
                name: asset.name,
                modelName: asset.modelName,
                serialNumber: asset.serialNumber,
                category: asset.category,
                location: asset.location
            });
            return new Promise(resolve => {
                const canvas = document.createElement('canvas');
                QRCode.toCanvas(canvas, qrData, { width: 150, margin: 1 }, error => {
                    if(error) resolve('');
                    else resolve(canvas.toDataURL());
                });
            });
        }
        const csvRows = [];
        for(const asset of assets) {
            const qrCodeDataURL = await getQRCodeDataURL(asset);
            const row = [
                `"${asset.managementNumber}"`,
                `"${asset.name.replace(/"/g,'""')}"`,
                `"${(asset.modelName||'').replace(/"/g,'""')}"`,
                `"${(asset.serialNumber||'').replace(/"/g,'""')}"`,
                `"${asset.category}"`,
                `"${asset.location}"`,
                asset.value || 0,
                asset.purchaseDate || '',
                asset.registrationDate || '',
                `"${(asset.description||'').replace(/"/g,'""')}"`,
                `"${qrCodeDataURL}"`
            ].join(',');
            csvRows.push(row);
        }
        const BOM = '\uFEFF';
        const csvContent = BOM + [headers.join(','), ...csvRows].join('\n');
        const blob = new Blob([csvContent], {type:'text/csv;charset=utf-8;'});
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `ë¸Œë¼ë³´ë¹„ë²„íŒŒì£¼_ìì‚°ëª©ë¡_${new Date().toISOString().split('T')[0]}.csv`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
    }

    // ëª©ë¡ ì¸ì‡„
    function printAssets() {
        window.print();
    }

    // í†µê³„ ì—…ë°ì´íŠ¸
    function updateStats() {
        document.getElementById('total-assets').textContent = assets.length;
        const totalValue = assets.reduce((sum,a) => sum + (a.value||0), 0);
        document.getElementById('total-value').textContent = totalValue.toLocaleString() + 'ì›';
        const categories = [...new Set(assets.map(a => a.category))];
        const locations = ['ì‚¬ë¬´ì‹¤', 'ì‘ì—…ì¥', 'ê·¸ë¼ìš´ë“œ'];
        document.getElementById('categories-count').textContent = categories.length;
        document.getElementById('locations-count').textContent = locations.length;

        const categoryStatsEl = document.getElementById('category-stats');
        categoryStatsEl.innerHTML = `
            <h3>ì¹´í…Œê³ ë¦¬ë³„ ë¶„í¬</h3>
            <div class="asset-grid">
                ${categories.map(cat => `
                    <div class="asset-card">
                        <h4>${cat}</h4>
                        <p>${assets.filter(a => a.category === cat).length}ê°œ</p>
                    </div>
                `).join('')}
            </div>
        `;

        const locationStatsEl = document.getElementById('location-stats');
        locationStatsEl.innerHTML = `
            <h3>ìœ„ì¹˜ë³„ ë¶„í¬</h3>
            <div class="asset-grid">
                ${locations.map(loc => `
                    <div class="asset-card">
                        <h4>${loc}</h4>
                        <p>${assets.filter(a => a.location === loc).length}ê°œ</p>
                    </div>
                `).join('')}
            </div>
        `;
    }

    // ì¹´ë©”ë¼ ë° QR ìŠ¤ìº” ê´€ë ¨
    let videoStream = null;
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const context = canvas.getContext('2d');
    const scanResult = document.getElementById('scan-result');

    async function startCamera() {
        try {
            videoStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
            video.srcObject = videoStream;
            video.setAttribute('playsinline', true);
            video.play();
            requestAnimationFrame(scanQRCode);
        } catch(err) {
            alert('ì¹´ë©”ë¼ ì ‘ê·¼ ì‹¤íŒ¨: ' + err.message);
        }
    }

    function stopCamera() {
        if(videoStream) {
            videoStream.getTracks().forEach(track => track.stop());
            videoStream = null;
            scanResult.textContent = '';
        }
    }

    function scanQRCode() {
        if(video.readyState === video.HAVE_ENOUGH_DATA) {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            const imageData = context.getImageData(0,0,canvas.width,canvas.height);
            const code = jsQR(imageData.data, imageData.width, imageData.height, {
                inversionAttempts: "dontInvert",
            });
            if(code) {
                scanResult.textContent = 'ìŠ¤ìº” ê²°ê³¼: ' + code.data;
                // ì˜ˆ: ìŠ¤ìº”í•œ ë°ì´í„°ì— ë”°ë¼ ìì‚° ì¡°íšŒ ê°€ëŠ¥ êµ¬í˜„ ì—¬ì§€
            } else {
                scanResult.textContent = 'QR ì½”ë“œë¥¼ ê°ì§€í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.';
            }
        }
        if(videoStream) requestAnimationFrame(scanQRCode);
    }
</script>

<script>
    // í˜ì´ì§€ ìµœì´ˆ ì§„ì… ì‹œ íƒ­ ì´ˆê¸°í™”
    document.addEventListener('DOMContentLoaded', () => {
        showTab('add', document.querySelector('.tab-button.active'));
    });
</script>

</body>
</html>

