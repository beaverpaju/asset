<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>브라보비버파주 자산관리 시스템</title>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box;}
        body { font-family: 'Arial', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px;}
        .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 15px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); padding: 30px;}
        .header { text-align: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 3px solid #667eea;}
        .header h1 { color: #333; font-size: 2.5em; margin-bottom: 10px;}
        .header p { color: #666; font-size: 1.1em;}
        .tabs { display: flex; margin-bottom: 30px; background: #f8f9fa; border-radius: 10px; padding: 5px;}
        .tab-button { flex: 1; padding: 15px 20px; border: none; background: transparent; cursor: pointer; border-radius: 8px; font-weight: bold; transition: all 0.3s ease; color: #666;}
        .tab-button.active { background: #667eea; color: white; box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);}
        .tab-content { display: none;}
        .tab-content.active { display: block;}
        .form-group { margin-bottom: 20px;}
        .form-group label { display: block; margin-bottom: 8px; font-weight: bold; color: #333;}
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px; border: 2px solid #e1e5e9; border-radius: 8px; font-size: 16px; transition: border-color 0.3s ease;}
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);}
        .btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 12px 25px; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; transition: transform 0.2s ease; margin-right: 10px; margin-bottom: 10px;}
        .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);}
        .btn-secondary { background: #6c757d;}
        .btn-danger { background: #dc3545;}
        .btn-success { background: #28a745;}
        .asset-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; margin-top: 20px;}
        .asset-card { background: white; border: 2px solid #e1e5e9; border-radius: 10px; padding: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.08); transition: transform 0.2s ease;}
        .asset-card:hover {transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0,0,0,0.15);}
        .asset-card h3 { color: #333; margin-bottom: 10px; font-size: 1.3em;}
        .asset-info { margin-bottom: 15px;}
        .asset-info span { display: block; margin-bottom: 5px; color: #666;}
        .qr-code { text-align: center; margin: 15px 0;}
        .qr-code canvas { border: 1px solid #ddd; border-radius: 8px;}
        .search-box { width: 100%; padding: 15px; font-size: 18px; border: 2px solid #667eea; border-radius: 10px; margin-bottom: 20px;}
        .search-box:focus { outline: none; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);}
        .stats {display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;}
        .stat-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 10px; text-align: center;}
        .stat-card h3 { font-size: 2em; margin-bottom: 5px;}
        .stat-card p { font-size: 1.1em; opacity: 0.9;}
        .camera-container { text-align: center; margin: 20px 0;}
        #video { width: 100%; max-width: 500px; border: 2px solid #667eea; border-radius: 10px;}
        .export-section { margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 10px;}
        @media (max-width: 768px) {
            .container { padding: 20px;}
            .tabs { flex-direction: column;}
            .tab-button { margin-bottom: 5px;}
            .asset-grid { grid-template-columns: 1fr;}
        }
        /* 수정 모달 */
        #edit-modal {
            display: none;
            position: fixed;
            z-index: 9999;
            left: 0; top: 0;
            width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.3);
            justify-content: center;
            align-items: center;
        }
        #edit-modal > div {
            background: white;
            padding: 30px;
            border-radius: 14px;
            min-width: 350px;
            max-width: 95vw;
            position: relative;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🏢 브라보비버파주 자산관리시스템</h1>
            <p>QR 코드 기반 자산 관리 솔루션</p>
        </div>

        <div class="tabs">
            <button class="tab-button active" onclick="showTab('add', this)">자산 등록</button>
            <button class="tab-button" onclick="showTab('list', this)">자산 목록</button>
            <button class="tab-button" onclick="showTab('scan', this)">QR 스캔</button>
            <button class="tab-button" onclick="showTab('stats', this)">통계</button>
        </div>

        <!-- 자산 등록 탭 -->
        <div id="add-tab" class="tab-content active">
            <h2>🔥 새 자산 등록</h2>
            <form id="asset-form">
                <div class="form-group">
                    <label for="assetName">자산명 *</label>
                    <input type="text" id="assetName" name="assetName" required placeholder="예: 노트북, 책상, 의자 등">
                </div>
                <div class="form-group">
                    <label for="modelName">모델명</label>
                    <input type="text" id="modelName" name="modelName" placeholder="예: ThinkPad X1 Carbon">
                </div>
                <div class="form-group">
                    <label for="serialNumber">시리얼넘버</label>
                    <input type="text" id="serialNumber" name="serialNumber" placeholder="예: SN1234567890">
                </div>
                <div class="form-group">
                    <label for="assetCategory">카테고리 *</label>
                    <select id="assetCategory" name="assetCategory" required>
                        <option value="">카테고리 선택</option>
                        <option value="전자기기">전자기기</option>
                        <option value="사무용품">사무용품</option>
                        <option value="가구">가구</option>
                        <option value="기계장비">기계장비</option>
                        <option value="차량">차량</option>
                        <option value="기타">기타</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="assetLocation">위치 *</label>
                    <select id="assetLocation" name="assetLocation" required>
                        <option value="">위치 선택</option>
                        <option value="사무실">사무실</option>
                        <option value="작업장">작업장</option>
                        <option value="그라운드">그라운드</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="assetValue">자산가치 (원)</label>
                    <input type="number" id="assetValue" name="assetValue" placeholder="예: 500000">
                </div>
                <div class="form-group">
                    <label for="purchaseDate">구입일자</label>
                    <input type="date" id="purchaseDate" name="purchaseDate">
                </div>
                <div class="form-group">
                    <label for="assetDescription">설명</label>
                    <textarea id="assetDescription" name="assetDescription" rows="3" placeholder="자산에 대한 추가 설명을 입력하세요"></textarea>
                </div>
                <button type="submit" class="btn">자산 등록 및 QR코드 생성</button>
            </form>
        </div>

        <!-- 자산 목록 탭 -->
        <div id="list-tab" class="tab-content">
            <h2>📋 자산 목록</h2>
            <input type="text" id="searchInput" class="search-box" placeholder="🔍 자산명, 카테고리, 위치로 검색하세요...">

            <div class="export-section">
                <h3>📊 데이터 내보내기</h3>
                <button class="btn btn-success" onclick="exportToCSV()">CSV 파일 다운로드</button>
                <button class="btn btn-secondary" onclick="printAssets()">목록 인쇄</button>
            </div>

            <div id="asset-list" class="asset-grid"></div>
        </div>

        <!-- QR 스캔 탭 -->
        <div id="scan-tab" class="tab-content">
            <h2>📱 QR 코드 스캔</h2>
            <div class="camera-container">
                <video id="video" autoplay></video>
                <canvas id="canvas" style="display:none;"></canvas>
            </div>
            <button class="btn" onclick="startCamera()">카메라 시작</button>
            <button class="btn btn-secondary" onclick="stopCamera()">카메라 중지</button>
            <div id="scan-result"></div>
        </div>

        <!-- 통계 탭 -->
        <div id="stats-tab" class="tab-content">
            <h2>📊 자산 통계</h2>
            <div class="stats">
                <div class="stat-card">
                    <h3 id="total-assets">0</h3>
                    <p>총 자산 수</p>
                </div>
                <div class="stat-card">
                    <h3 id="total-value">0원</h3>
                    <p>총 자산 가치</p>
                </div>
                <div class="stat-card">
                    <h3 id="categories-count">0</h3>
                    <p>카테고리 수</p>
                </div>
                <div class="stat-card">
                    <h3 id="locations-count">3</h3>
                    <p>위치 수</p>
                </div>
            </div>
            <div id="category-stats"></div>
            <div id="location-stats"></div>
        </div>
    </div>

    <!-- 자산 정보 수정 모달 -->
    <div id="edit-modal">
        <div>
            <form id="edit-form">
                <h2>자산 정보 수정</h2>
                <input type="hidden" id="edit-id" />
                <div class="form-group">
                    <label>자산명 *</label>
                    <input type="text" id="edit-assetName" required />
                </div>
                <div class="form-group">
                    <label>모델명</label>
                    <input type="text" id="edit-modelName" />
                </div>
                <div class="form-group">
                    <label>시리얼넘버</label>
                    <input type="text" id="edit-serialNumber" />
                </div>
                <div class="form-group">
                    <label>카테고리 *</label>
                    <select id="edit-assetCategory" required>
                        <option value="">카테고리 선택</option>
                        <option value="전자기기">전자기기</option>
                        <option value="사무용품">사무용품</option>
                        <option value="가구">가구</option>
                        <option value="기계장비">기계장비</option>
                        <option value="차량">차량</option>
                        <option value="기타">기타</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>위치 *</label>
                    <select id="edit-assetLocation" required>
                        <option value="">위치 선택</option>
                        <option value="사무실">사무실</option>
                        <option value="작업장">작업장</option>
                        <option value="그라운드">그라운드</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>가치 (원)</label>
                    <input type="number" id="edit-assetValue" />
                </div>
                <div class="form-group">
                    <label>구입일자</label>
                    <input type="date" id="edit-purchaseDate" />
                </div>
                <div class="form-group">
                    <label>설명</label>
                    <textarea id="edit-assetDescription" rows="3"></textarea>
                </div>
                <button type="submit" class="btn btn-success">저장</button>
                <button type="button" class="btn btn-secondary" onclick="closeEditModal()">취소</button>
            </form>
        </div>
    </div>

    <script>
        // 안전하게 localStorage에서 데이터 읽기
        let assets = [];
        const storedAssets = localStorage.getItem('assets');
        if (storedAssets) {
            try {
                assets = JSON.parse(storedAssets);
            } catch {
                assets = [];
            }
        }

        let videoStream = null;

        // 탭 전환함수
        function showTab(tabName, buttonElem) {
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(button => button.classList.remove('active'));
            document.getElementById(tabName + '-tab').classList.add('active');
            buttonElem.classList.add('active');
            if (tabName === 'list') displayAssets();
            if (tabName === 'stats') updateStats();
        }

        // 자산 등록
        document.getElementById('asset-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const asset = {
                id: Date.now().toString(),
                name: formData.get('assetName'),
                modelName: formData.get('modelName'),
                serialNumber: formData.get('serialNumber'),
                category: formData.get('assetCategory'),
                location: formData.get('assetLocation'),
                value: parseInt(formData.get('assetValue')) || 0,
                purchaseDate: formData.get('purchaseDate'),
                description: formData.get('assetDescription'),
                registrationDate: new Date().toISOString().split('T')[0]
            };
            assets.push(asset);
            localStorage.setItem('assets', JSON.stringify(assets));
            alert('자산이 성공적으로 등록되었습니다!');
            e.target.reset();
        });

        // 자산 목록 표시
        function displayAssets(filteredAssets = null) {
            const assetList = document.getElementById('asset-list');
            const assetsToShow = filteredAssets || assets;
            if (assetsToShow.length === 0) {
                assetList.innerHTML = '<div style="text-align: center; padding: 50px; color: #666;">등록된 자산이 없습니다.</div>';
                return;
            }
            assetList.innerHTML = assetsToShow.map(asset => `
                <div class="asset-card">
                    <h3>${asset.name}</h3>
                    <div class="asset-info">
                        <span><strong>모델명:</strong> ${asset.modelName || '미입력'}</span>
                        <span><strong>시리얼넘버:</strong> ${asset.serialNumber || '미입력'}</span>
                        <span><strong>카테고리:</strong> ${asset.category}</span>
                        <span><strong>위치:</strong> ${asset.location}</span>
                        <span><strong>가치:</strong> ${asset.value ? asset.value.toLocaleString() + '원' : '미입력'}</span>
                        <span><strong>구입일:</strong> ${asset.purchaseDate || '미입력'}</span>
                        <span><strong>등록일:</strong> ${asset.registrationDate}</span>
                        ${asset.description ? `<span><strong>설명:</strong> ${asset.description}</span>` : ''}
                    </div>
                    <div class="qr-code" id="qr-${asset.id}"></div>
                    <button class="btn btn-danger" onclick="deleteAsset('${asset.id}')">삭제</button>
                    <button class="btn btn-secondary" onclick="downloadQR('${asset.id}')">QR 다운로드</button>
                    <button class="btn btn-secondary" onclick="editAsset('${asset.id}')">수정</button>
                </div>
            `).join('');
            assetsToShow.forEach(asset => {
                const qrData = JSON.stringify({
                    id: asset.id,
                    name: asset.name,
                    modelName: asset.modelName,
                    serialNumber: asset.serialNumber,
                    category: asset.category,
                    location: asset.location
                });
                QRCode.toCanvas(document.getElementById(`qr-${asset.id}`), qrData, {
                    width: 150,
                    margin: 1,
                    color: { dark: '#000000', light: '#FFFFFF' }
                }, function (error) {
                    if (error) console.error(error);
                });
            });
        }

        // 자산 삭제
        function deleteAsset(id) {
            if (confirm('정말로 이 자산을 삭제하시겠습니까?')) {
                assets = assets.filter(asset => asset.id !== id);
                localStorage.setItem('assets', JSON.stringify(assets));
                displayAssets();
                updateStats();
            }
        }

        // QR 코드 다운로드 PNG
        function downloadQR(id) {
            const canvas = document.querySelector(`#qr-${id} canvas`);
            if (canvas) {
                const link = document.createElement('a');
                link.download = `qr-code-${id}.png`;
                link.href = canvas.toDataURL();
                link.click();
            }
        }

        // 검색 필터
        document.getElementById('searchInput').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            const filteredAssets = assets.filter(asset => 
                asset.name.toLowerCase().includes(searchTerm) ||
                asset.category.toLowerCase().includes(searchTerm) ||
                asset.location.toLowerCase().includes(searchTerm) ||
                (asset.description && asset.description.toLowerCase().includes(searchTerm)) ||
                (asset.modelName && asset.modelName.toLowerCase().includes(searchTerm)) ||
                (asset.serialNumber && asset.serialNumber.toLowerCase().includes(searchTerm))
            );
            displayAssets(filteredAssets);
        });

        // CSV 다운로드(한글깨짐 및 QR코드 포함)
        async function exportToCSV() {
            if (assets.length === 0) {
                alert('내보낼 자산이 없습니다.');
                return;
            }
            const headers = ['자산명','모델명','시리얼넘버','카테고리','위치','가치','구입일','등록일','설명','QR코드(Base64)'];

            async function getQRCodeDataURL(asset) {
                const qrData = JSON.stringify({
                    id: asset.id,
                    name: asset.name,
                    modelName: asset.modelName,
                    serialNumber: asset.serialNumber,
                    category: asset.category,
                    location: asset.location
                });
                return new Promise((resolve) => {
                    const canvas = document.createElement('canvas');
                    QRCode.toCanvas(canvas, qrData, { width: 150, margin: 1 }, (error) => {
                        if (error) return resolve('');
                        resolve(canvas.toDataURL());
                    });
                });
            }

            const csvRows = [];
            for (const asset of assets) {
                const qrCodeDataURL = await getQRCodeDataURL(asset);
                const row = [
                    `"${asset.name.replace(/"/g, '""')}"`,
                    `"${(asset.modelName || '').replace(/"/g, '""')}"`,
                    `"${(asset.serialNumber || '').replace(/"/g, '""')}"`,
                    `"${asset.category}"`,
                    `"${asset.location}"`,
                    asset.value || 0,
                    asset.purchaseDate || '',
                    asset.registrationDate,
                    `"${(asset.description || '').replace(/"/g, '""')}"`,
                    `"${qrCodeDataURL}"`
                ].join(',');
                csvRows.push(row);
            }

            const BOM = '\uFEFF';
            const csvContent = BOM + [headers.join(','), ...csvRows].join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `브라보비버파주_자산목록_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        // 인쇄
        function printAssets() {
            window.print();
        }

        // 통계 업데이트
        function updateStats() {
            document.getElementById('total-assets').textContent = assets.length;
            const totalValue = assets.reduce((sum, asset) => sum + (asset.value || 0), 0);
            document.getElementById('total-value').textContent = totalValue.toLocaleString() + '원';
            const categories = [...new Set(assets.map(asset => asset.category))];
            document.getElementById('categories-count').textContent = categories.length;
            const categoryStats = document.getElementById('category-stats');
            const categoryData = categories.map(category => ({
                category,
                count: assets.filter(asset => asset.category === category).length
            }));
            categoryStats.innerHTML = `
                <h3>카테고리별 분포</h3>
                <div class="asset-grid">
                    ${categoryData.map(data => `
                        <div class="asset-card">
                            <h4>${data.category}</h4>
                            <p>${data.count}개</p>
                        </div>
                    `).join('')}
                </div>
            `;
            const locations = ['사무실','작업장','그라운드'];
            const locationStats = document.getElementById('location-stats');
            const locationData = locations.map(location => ({
                location,
                count: assets.filter(asset => asset.location === location).length
            }));
            locationStats.innerHTML = `
                <h3>위치별 분포</h3>
                <div class="asset-grid">
                    ${locationData.map(data => `
                        <div class="asset-card">
                            <h4>${data.location}</h4>
                            <p>${data.count}개</p>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // 카메라 시작
        async function startCamera() {
            try {
                videoStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                const video = document.getElementById('video');
                video.srcObject = videoStream;
                video.play();
                scanQRCode();
            } catch (error) {
                alert('카메라에 접근할 수 없습니다: ' + error.message);
            }
        }

        // 카메라 중지
        function stopCamera() {
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                videoStream = null;
            }
        }

        // QR 코드 스캔
        function scanQRCode() {
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            const context = canvas.getContext('2d');
            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                context.drawImage(video, 0, 0, canvas.width, canvas.height);
                const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
                const code = jsQR(imageData.data, imageData.width, imageData.height);
                if (code) {
                    try {
                        const qrData = JSON.parse(code.data);
                        const asset = assets.find(a => a.id === qrData.id);
                        if (asset) {
                            document.getElementById('scan-result').innerHTML = `
                                <div class="asset-card">
                                    <h3>✅ 자산 정보</h3>
                                    <div class="asset-info">
                                        <span><strong>자산명:</strong> ${asset.name}</span>
                                        <span><strong>모델명:</strong> ${asset.modelName || '미입력'}</span>
                                        <span><strong>시리얼넘버:</strong> ${asset.serialNumber || '미입력'}</span>
                                        <span><strong>카테고리:</strong> ${asset.category}</span>
                                        <span><strong>위치:</strong> ${asset.location}</span>
                                        <span><strong>가치:</strong> ${asset.value ? asset.value.toLocaleString() + '원' : '미입력'}</span>
                                        <span><strong>구입일:</strong> ${asset.purchaseDate || '미입력'}</span>
                                    </div>
                                </div>
                            `;
                        } else {
                            document.getElementById('scan-result').innerHTML = '<div class="asset-card"><h3>❌ 해당 자산을 찾을 수 없습니다.</h3></div>';
                        }
                    } catch (error) {
                        document.getElementById('scan-result').innerHTML = '<div class="asset-card"><h3>❌ 올바르지 않은 QR 코드입니다.</h3></div>';
                    }
                }
            }
            if (videoStream) requestAnimationFrame(scanQRCode);
        }

        // 자산 정보 수정 함수
        function editAsset(id) {
            const asset = assets.find(a => a.id === id);
            if (!asset) return;
            document.getElementById('edit-id').value = asset.id;
            document.getElementById('edit-assetName').value = asset.name;
            document.getElementById('edit-modelName').value = asset.modelName || '';
            document.getElementById('edit-serialNumber').value = asset.serialNumber || '';
            document.getElementById('edit-assetCategory').value = asset.category;
            document.getElementById('edit-assetLocation').value = asset.location;
            document.getElementById('edit-assetValue').value = asset.value || '';
            document.getElementById('edit-purchaseDate').value = asset.purchaseDate || '';
            document.getElementById('edit-assetDescription').value = asset.description || '';
            document.getElementById('edit-modal').style.display = 'flex';
        }

        // 수정 폼 저장 처리
        document.getElementById('edit-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const id = document.getElementById('edit-id').value;
            const idx = assets.findIndex(a => a.id === id);
            if (idx === -1) return;
            assets[idx] = {
                ...assets[idx],
                name: document.getElementById('edit-assetName').value,
                modelName: document.getElementById('edit-modelName').value,
                serialNumber: document.getElementById('edit-serialNumber').value,
                category: document.getElementById('edit-assetCategory').value,
                location: document.getElementById('edit-assetLocation').value,
                value: parseInt(document.getElementById('edit-assetValue').value) || 0,
                purchaseDate: document.getElementById('edit-purchaseDate').value,
                description: document.getElementById('edit-assetDescription').value
            };
            localStorage.setItem('assets', JSON.stringify(assets));
            closeEditModal();
            displayAssets();
            updateStats();
            alert('자산 정보가 수정되었습니다!');
        });

        // 수정 모달 닫기
        function closeEditModal() {
            document.getElementById('edit-modal').style.display = 'none';
        }

        displayAssets();
        updateStats();
    </script>
</body>
</html>
